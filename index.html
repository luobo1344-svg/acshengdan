<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº‘ç«¯é­”æ³•åœ£è¯æ ‘ (ä¿®å¤ç‰ˆ)</title>
    
    <!-- ========================================== -->
    <!-- å…³é”®ä¿®æ”¹ï¼šç›´æ¥ä½¿ç”¨åœ¨çº¿ CDN åº“ï¼Œä¸ç”¨ä¸‹è½½æœ¬åœ°æ–‡ä»¶äº† -->
    <!-- ========================================== -->
    
    <!-- 1. å¼•å…¥ Three.js æ ¸å¿ƒåº“ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/three.min.js"></script>
    <!-- 2. å¼•å…¥ é¼ æ ‡æ§åˆ¶åº“ -->
    <script src="https://cdn.bootcdn.net/ajax/libs/three.js/r128/examples/js/controls/OrbitControls.js"></script>
    
    <!-- 3. å¼•å…¥ Bmob åç«¯åº“ (v4ç‰ˆæœ¬) -->
    <script src="https://unpkg.com/bmob-js-sdk-v4@4.0.0/dist/Bmob-4.0.0.min.js"></script>

    <!-- æ³¨æ„ï¼šä¸ºäº†å…ˆä¿è¯ä¸é»‘å±ï¼Œæˆ‘æš‚æ—¶æ³¨é‡Šæ‰äº†å‘å…‰ç‰¹æ•ˆåº“ï¼Œå› ä¸ºé‚£éœ€è¦æ›´å¤æ‚çš„é…ç½® -->
    <!-- <script src="./EffectComposer.js"></script> -->
    <!-- <script src="./RenderPass.js"></script> -->
    <!-- <script src="./UnrealBloomPass.js"></script> -->

    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: 'Segoe UI', sans-serif; }
        canvas { display: block; }
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; padding: 20px; box-sizing: border-box; z-index: 10;
        }
        .glass-panel {
            background: rgba(20, 20, 35, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 16px; padding: 15px; color: white;
            pointer-events: auto; text-align: center;
        }
        h1 { margin: 0 0 5px 0; font-size: 1.5rem; color: #fff; text-shadow: 0 0 10px #00ff88; }
        p { font-size: 0.8rem; color: #ccc; margin: 0; }
        .btn-group { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .btn {
            border: none; padding: 8px 16px; border-radius: 20px; font-size: 0.9rem; cursor: pointer; color: white; transition: 0.3s; display: flex; align-items: center; gap: 5px;
        }
        .btn-upload { background: linear-gradient(135deg, #ff0055, #ff5588); box-shadow: 0 4px 15px rgba(255,0,85,0.4); }
        .btn-upload:hover { transform: scale(1.05); }
        .btn-clear { background: rgba(255,255,255,0.1); border: 1px solid #555; font-size: 0.8rem; }
        #file-input { display: none; }
        .status-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; font-size: 12px; color: #00ff88;
        }
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top: 3px solid #00ff88; border-radius: 50%; animation: spin 1s infinite linear; margin-bottom: 20px; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loader"><div class="spinner"></div><div id="loader-text">èµ„æºåŠ è½½ä¸­...</div></div>
    <div id="ui-layer">
        <div class="glass-panel" style="margin: 0 auto; max-width: 400px;">
            <h1>ğŸ„ é­”æ³•äº‘ç«¯æ ‘</h1>
            <p>ç…§ç‰‡å·²äº‘ç«¯åŒæ­¥ â€¢ ä¸åŒè®¾å¤‡å¯è§</p>
            <div class="btn-group">
                <label class="btn btn-upload">ğŸ“· æ·»åŠ ç…§ç‰‡<input type="file" id="file-input" accept="image/*" multiple></label>
                <button class="btn btn-clear" onclick="clearMemories()">ğŸ—‘ï¸ æ¸…ç©ºé‡ç½®</button>
            </div>
            <p style="margin-top: 8px; font-size: 0.7rem; opacity: 0.6;">æ‰‹åŠ¿åŠŸèƒ½å·²ä¸´æ—¶ç¦ç”¨</p>
        </div>
        <div class="status-bar" id="status-text">ç³»ç»Ÿå°±ç»ª</div>
    </div>

    <script>
        // Bmob é…ç½®
        const SECRET_KEY = "c9f545074cd83b7b"; 
        const API_KEY = "1343356157845614";
        
        // ----------------------------------------------------
        // 1. åˆå§‹åŒ– Bmob
        // ----------------------------------------------------
        try {
            // æ³¨æ„ï¼šBmob v4 çš„åˆå§‹åŒ–é€šå¸¸åªéœ€è¦ Secret Key å’Œ API Safe Key
            // å¦‚æœæŠ¥é”™ï¼Œè¯´æ˜ä½ çš„ Key ç±»å‹å¯èƒ½éœ€è¦è°ƒæ•´ï¼Œä½†è¿™é‡Œå…ˆæŒ‰ä½ çš„å†™
            Bmob.initialize(SECRET_KEY, API_KEY);
            console.log("Bmob åˆå§‹åŒ–å°è¯•å®Œæˆ");
        } catch(e) {
            console.error("Bmob åˆå§‹åŒ–è­¦å‘Š:", e);
        }

        let scene, camera, renderer, controls;
        let treeSystem, photoGroup;

        // ----------------------------------------------------
        // 2. åˆå§‹åŒ– 3D åœºæ™¯
        // ----------------------------------------------------
        function initScene() {
            try {
                // åˆ›å»ºåœºæ™¯
                scene = new THREE.Scene();
                
                // åˆ›å»ºç›¸æœº
                camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
                camera.position.set(0, 10, 60);

                // åˆ›å»ºæ¸²æŸ“å™¨
                renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                document.body.appendChild(renderer.domElement);

                // æ·»åŠ é¼ æ ‡æ§åˆ¶
                if (typeof THREE.OrbitControls === 'function') {
                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                } else {
                    // å…¼å®¹ä¸åŒç‰ˆæœ¬çš„åŠ è½½æ–¹å¼
                    controls = new THREE.OrbitControls(camera, renderer.domElement);
                }
                controls.enableDamping = true;
                controls.autoRotate = true;
                controls.autoRotateSpeed = 1.0;

                // åˆ›å»ºç²’å­åœ£è¯æ ‘
                createParticles();
                
                photoGroup = new THREE.Group();
                scene.add(photoGroup);

                // éšè—åŠ è½½åŠ¨ç”»
                document.getElementById('loader').style.display = 'none';

                // å¼€å§‹åŠ¨ç”»å¾ªç¯
                animate();
                
                console.log("3D åœºæ™¯åˆå§‹åŒ–æˆåŠŸï¼");

            } catch (e) {
                document.getElementById('loader-text').innerText = 'é”™è¯¯: 3Då¼•æ“å¯åŠ¨å¤±è´¥';
                document.getElementById('loader-text').style.color = 'red';
                console.error("Three.js åˆå§‹åŒ–å¤±è´¥: ", e);
                alert("åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æŠ¥é”™ (F12)");
            }
        }
        
        function createParticles() {
            const geometry = new THREE.BufferGeometry();
            const count = 3000;
            const positions = new Float32Array(count * 3);
            
            for(let i=0; i<count; i++) {
                const p = i / count;
                const angle = i * 0.2;
                // è°ƒæ•´ä¸€ä¸‹æ ‘çš„å½¢çŠ¶å‚æ•°
                const r = 18 * (1 - p); 
                
                positions[i*3] = Math.cos(angle) * r;     // x
                positions[i*3+1] = p * 40 - 20;           // y (é«˜åº¦)
                positions[i*3+2] = Math.sin(angle) * r;   // z
            }
            
            geometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
            
            const mat = new THREE.PointsMaterial({ 
                color: 0x00ff88, 
                size: 0.6,
                transparent: true,
                opacity: 0.9
            });
            
            treeSystem = new THREE.Points(geometry, mat);
            scene.add(treeSystem);
        }

        function animate() {
            requestAnimationFrame(animate);
            if(controls) controls.update();
            if(renderer && scene && camera) {
                renderer.render(scene, camera);
            }
        }

        // çª—å£å¤§å°æ”¹å˜è‡ªé€‚åº”
        window.addEventListener('resize', () => {
            if(camera && renderer) {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            }
        });

        // ----------------------------------------------------
        // 3. å¯åŠ¨æ£€æŸ¥
        // ----------------------------------------------------
        document.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥åº“æ˜¯å¦åŠ è½½æˆåŠŸ
            if (typeof THREE === 'undefined') {
                 document.getElementById('loader-text').innerText = 'é”™è¯¯: æ— æ³•è¿æ¥åˆ° Three.js æœåŠ¡å™¨ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚';
                 return;
            }
            
            // å°±ç®— Bmob å¤±è´¥ï¼Œä¹Ÿè¦å…ˆæŠŠæ ‘ç”»å‡ºæ¥
            initScene();
        });

        window.clearMemories = () => { alert('åŠŸèƒ½å°†åœ¨ä¿®å¤åæ¢å¤'); };
        document.getElementById('file-input').addEventListener('change', () => { alert('åŠŸèƒ½å°†åœ¨ä¿®å¤åæ¢å¤'); });

    </script>
</body>
</html>
