<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>äº‘ç«¯é­”æ³•åœ£è¯æ ‘ (acåœ£è¯å¿«ä¹)</title>
    
    <!-- 1. æ›´æ¢ä¸ºé˜¿é‡Œ/ä¸ƒç‰›äº‘ Staticfile CDN (å›½å†…æœ€ç¨³) -->
    <script src="https://cdn.staticfile.org/three.js/r128/three.min.js"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/postprocessing/EffectComposer.js"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/postprocessing/RenderPass.js"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/postprocessing/ShaderPass.js"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/shaders/CopyShader.js"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/shaders/LuminosityHighPassShader.js"></script>
    <script src="https://cdn.staticfile.org/three.js/r128/examples/js/postprocessing/UnrealBloomPass.js"></script>

    <!-- Bmob SDK -->
    <script src="https://code.bdstatic.com/npm/bmob.js-sdk-v4@2.5.10/dist/Bmob-2.5.10.min.js"></script>

    <!-- AI æ‰‹åŠ¿ (åŠ è½½å¤±è´¥ä¸å½±å“ä¸»ç¨‹åº) -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-core"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-backend-webgl"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/hand-pose-detection"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #050505; font-family: sans-serif; }
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
            transition: opacity 0.5s;
        }
        .btn-group { position:absolute; top:20px; left:50%; transform:translate(-50%); z-index:10; display: flex; gap:10px; }
        .btn { padding: 8px 16px; border-radius: 20px; border:none; cursor:pointer; background:rgba(255,255,255,0.2); color:white; backdrop-filter:blur(5px); }
        .btn-up { background: linear-gradient(135deg, #ff0055, #ff5588); }
        #status { position:absolute; bottom:20px; left:20px; color:#00ff88; font-size:12px; pointer-events:none; }
    </style>
</head>
<body>

    <div id="loader">
        <div style="font-size: 30px;">ğŸ„</div>
        <div id="loader-text" style="margin-top:15px; color:#aaa;">æ­£åœ¨è¿æ¥é­”æ³•äº‘ç«¯...</div>
        <div id="error-msg" style="margin-top:10px; color:#ff4444; font-size:12px; max-width:80%; text-align:center;"></div>
    </div>

    <div class="btn-group">
        <label class="btn btn-up">ğŸ“· ä¼ ç…§ç‰‡ <input type="file" hidden multiple id="file-input" accept="image/*"></label>
        <button class="btn" onclick="clearMemories()">ğŸ—‘ï¸ æ¸…ç©º</button>
    </div>
    <div id="status">ç­‰å¾…å°±ç»ª...</div>

    <script>
        // ============================================
        // å…¨å±€é”™è¯¯æ•è· (å¸®ä½ æ‰¾å‡ºé—®é¢˜)
        // ============================================
        window.onerror = function(msg, url, line) {
            const errorText = `å‡ºé”™å•¦: ${msg} (ç¬¬${line}è¡Œ)`;
            document.getElementById('error-msg').innerText = errorText;
            document.getElementById('loader-text').innerText = "åŠ è½½å¤±è´¥ï¼Œè¯·æˆªå›¾å‘ç»™ä½œè€…";
            // 3ç§’åå¼ºåˆ¶è¿›å…¥ï¼Œä¿è¯èƒ½ç©
            setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 3000);
        };

        // ============================================
        // 1. é‡ç‚¹æ£€æŸ¥åŒºåŸŸï¼šè¯·å¡«å…¥ä½ çš„ Bmob Key
        // ============================================
        // æ³¨æ„ï¼šä¸è¦åˆ æ‰åŒå¼•å·ï¼ä¸è¦æœ‰å¤šä½™ç©ºæ ¼ï¼
        const SECRET_KEY = "c9f545074cd83b7b"; 
        const API_KEY = "1343356157845614";

        // ============================================
        // 2. åˆå§‹åŒ–é€»è¾‘
        // ============================================
        let isOffline = false;
        
        // 5ç§’å¼ºåˆ¶è¶…æ—¶æœºåˆ¶ï¼šå¦‚æœç½‘å¤ªå¡ï¼Œç›´æ¥è¿›å…¥
        setTimeout(() => {
            const loader = document.getElementById('loader');
            if(loader && loader.style.display !== 'none') {
                console.warn("åŠ è½½è¶…æ—¶ï¼Œå¼ºåˆ¶è¿›å…¥");
                loader.style.display = 'none';
            }
        }, 8000);

        try {
            if (typeof Bmob === 'undefined') {
                throw new Error("Bmob SDK åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
            }
            if (SECRET_KEY.includes("c9f545074cd83b7b")) {
                isOffline = true;
                console.log("æœªå¡« Keyï¼Œè¿›å…¥ç¦»çº¿æ¨¡å¼");
            } else {
                Bmob.initialize(SECRET_KEY, API_KEY);
            }
        } catch(e) {
            console.error(e);
            document.getElementById('error-msg').innerText = "äº‘ç«¯è¿æ¥å¤±è´¥: " + e.message;
            isOffline = true; // é™çº§ä¸ºç¦»çº¿æ¨¡å¼
        }

        // ============================================
        // 3. Three.js åœºæ™¯
        // ============================================
        let scene, camera, renderer, composer, controls, photoGroup, treeSystem;
        let time = 0;
        
        function init() {
            if (typeof THREE === 'undefined') {
                alert("Three.js æ ¸å¿ƒåº“æœªåŠ è½½ï¼è¯·åˆ·æ–°é¡µé¢é‡è¯•");
                return;
            }

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x050505, 0.02);
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 500);
            camera.position.set(0, 5, 50);

            renderer = new THREE.WebGLRenderer({ antialias: window.innerWidth > 800 });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            // å°è¯•å¼€å¯è¾‰å…‰ï¼Œå¦‚æœè®¾å¤‡ä¸æ”¯æŒåˆ™å¿½ç•¥
            try {
                composer = new THREE.EffectComposer(renderer);
                composer.addPass(new THREE.RenderPass(scene, camera));
                const bloom = new THREE.UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
                bloom.threshold = 0; bloom.strength = 1.2; bloom.radius = 0.5;
                composer.addPass(bloom);
            } catch(e) {
                console.warn("è¾‰å…‰æ•ˆæœå¼€å¯å¤±è´¥ï¼Œå·²è‡ªåŠ¨å…³é—­");
                composer = null; // é™çº§æ¸²æŸ“
            }

            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;

            createTree();
            photoGroup = new THREE.Group();
            scene.add(photoGroup);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                if(composer) composer.setSize(window.innerWidth, window.innerHeight);
            });

            animate();
            fetchMemories(); // å¼€å§‹æ‹‰å–ç…§ç‰‡
        }

        function createTree() {
            const geo = new THREE.BufferGeometry();
            const count = 2000;
            const pos = [], cols = [];
            for(let i=0; i<count; i++) {
                const p = i/count;
                const r = 15 * (1-p);
                const angle = i * 0.15;
                pos.push(Math.cos(angle)*r, p*40-20, Math.sin(angle)*r);
                const c = new THREE.Color().setHSL(Math.random()*0.3+0.3, 1.0, 0.5);
                cols.push(c.r, c.g, c.b);
            }
            geo.setAttribute('position', new THREE.Float32BufferAttribute(pos, 3));
            geo.setAttribute('color', new THREE.Float32BufferAttribute(cols, 3));
            const mat = new THREE.PointsMaterial({ size: 0.6, vertexColors: true, blending: THREE.AdditiveBlending });
            treeSystem = new THREE.Points(geo, mat);
            scene.add(treeSystem);
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.01;
            controls.update();
            if(treeSystem) {
                treeSystem.rotation.y = time * 0.1;
                treeSystem.scale.setScalar(1 + Math.sin(time)*0.05);
            }
            if(composer) composer.render();
            else renderer.render(scene, camera);
        }

        // ============================================
        // 4. æ•°æ®äº¤äº’
        // ============================================
        async function fetchMemories() {
            document.getElementById('loader-text').innerText = "æ­£åœ¨åŒæ­¥äº‘ç«¯ç…§ç‰‡...";
            
            try {
                let list = [];
                if(isOffline) {
                    list = JSON.parse(localStorage.getItem('local_memories') || '[]');
                } else {
                    const query = Bmob.Query("Memories");
                    query.order("-createdAt");
                    query.limit(50);
                    list = await query.find();
                }
                
                // æ¸²æŸ“ç…§ç‰‡
                photoGroup.clear();
                list.forEach((item, i) => {
                    const src = item.imageData || item.url; // å…¼å®¹ä¸åŒå­—æ®µ
                    if(!src) return;
                    const img = new Image();
                    img.src = src;
                    img.onload = () => {
                        const sprite = new THREE.Sprite(new THREE.SpriteMaterial({map: new THREE.Texture(img)}));
                        const angle = i * 1.5;
                        const r = 10 + i*0.5;
                        sprite.position.set(Math.cos(angle)*r, 30-i*1.2, Math.sin(angle)*r);
                        sprite.scale.set(5,5,1);
                        photoGroup.add(sprite);
                    }
                });
                
                // æˆåŠŸï¼éšè—åŠ è½½å±‚
                document.getElementById('loader').style.display = 'none';

            } catch(e) {
                console.error(e);
                document.getElementById('error-msg').innerText = "æ•°æ®è·å–å¤±è´¥: " + e.message;
                // å³ä½¿å¤±è´¥ï¼Œ3ç§’åä¹Ÿè¿›å…¥åœºæ™¯
                setTimeout(() => { document.getElementById('loader').style.display = 'none'; }, 2000);
            }
        }

        // å‹ç¼©ä¸ä¸Šä¼ 
        document.getElementById('file-input').addEventListener('change', async (e) => {
            if(!e.target.files.length) return;
            const status = document.getElementById('status');
            status.innerText = "æ­£åœ¨å¤„ç†å›¾ç‰‡...";
            
            for(let file of e.target.files) {
                try {
                    // å‹ç¼©
                    const base64 = await new Promise(resolve => {
                        const r = new FileReader(); r.readAsDataURL(file);
                        r.onload = ev => {
                            const img = new Image(); img.src = ev.target.result;
                            img.onload = () => {
                                const cvs = document.createElement('canvas');
                                const max = 600;
                                let w=img.width, h=img.height;
                                if(Math.max(w,h)>max) { const s=max/Math.max(w,h); w*=s; h*=s; }
                                cvs.width=w; cvs.height=h;
                                cvs.getContext('2d').drawImage(img,0,0,w,h);
                                resolve(cvs.toDataURL('image/jpeg', 0.7));
                            }
                        }
                    });

                    // ä¸Šä¼ 
                    status.innerText = "æ­£åœ¨ä¸Šä¼ ...";
                    if(isOffline) {
                        const list = JSON.parse(localStorage.getItem('local_memories')||'[]');
                        list.unshift({imageData: base64});
                        localStorage.setItem('local_memories', JSON.stringify(list));
                    } else {
                        const q = Bmob.Query('Memories');
                        q.set('imageData', base64);
                        await q.save();
                    }
                } catch(err) { alert("ä¸Šä¼ å¤±è´¥:"+err.message); }
            }
            status.innerText = "ä¸Šä¼ å®Œæˆ!";
            fetchMemories();
        });

        window.clearMemories = () => {
            if(confirm("ç¡®å®šæ¸…ç©ºå—ï¼Ÿ")) {
                if(isOffline) { localStorage.removeItem('local_memories'); fetchMemories(); }
                else alert("æ¼”ç¤ºç‰ˆä¸ºäº†æ•°æ®å®‰å…¨ï¼Œæš‚ä¸æ”¯æŒäº‘ç«¯æ¸…ç©ºï¼Œè¯·å»åå°æ“ä½œ");
            }
        }

        // å¯åŠ¨
        init();

    </script>
</body>
</html>
