<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>äº‘ç«¯é­”æ³•åœ£è¯æ ‘ (acåœ£è¯å¿«ä¹)</title>
    
    <!-- 1. åªå¼•å…¥ä¸¤ä¸ªæœ€æ ¸å¿ƒçš„æ–‡ä»¶ (360 Baomitu æº) -->
    <script src="https://lib.baomitu.com/three.js/r128/three.min.js"></script>
    <script src="./OrbitControls.js"></script>
    
    <!-- 2. Bmob äº‘ç«¯æ•°æ®åº“ -->
    <script src="https://code.bdstatic.com/npm/bmob.js-sdk-v4@2.5.10/dist/Bmob-2.5.10.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        
        /* åŠ è½½å±‚æ ·å¼ */
        #loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #000; z-index: 99;
            display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;
        }
        
        /* æŒ‰é’®æ ·å¼ */
        .btn-group { position:absolute; top:20px; left:50%; transform:translate(-50%); z-index:10; display: flex; gap:15px; }
        .btn { 
            padding: 10px 20px; border-radius: 25px; border:1px solid rgba(255,255,255,0.3); 
            cursor:pointer; background:rgba(0,0,0,0.5); color:white; font-size: 14px;
        }
        .btn-up { background: #ff0055; border:none; box-shadow: 0 0 10px #ff0055; }
        
        /* é”™è¯¯æç¤º */
        #debug { position:absolute; bottom:10px; left:10px; color:gray; font-size:10px; pointer-events:none; }
    </style>
</head>
<body>

    <div id="loader">
        <div style="font-size: 40px;">ğŸ„</div>
        <div id="loader-text" style="margin-top:15px; color:#aaa;">æ­£åœ¨è¿æ¥...</div>
    </div>

    <div class="btn-group">
        <label class="btn btn-up">
            ğŸ“· ä¼ ç…§ç‰‡ 
            <input type="file" hidden multiple id="file-input" accept="image/*">
        </label>
        <button class="btn" onclick="clearMemories()">ğŸ—‘ï¸ æ¸…ç©º</button>
    </div>

    <div id="debug">System Ready</div>

    <script>
        // ============================================
        // âš ï¸ ç¬¬ä¸€æ­¥ï¼šåœ¨è¿™é‡Œå¡«å…¥ä½ çš„ Key (ä¸è¦åˆ å¼•å·)
        // ============================================
        const SECRET_KEY = "c9f545074cd83b7b"; 
        const API_KEY = "1343356157845614";

        // ============================================
        // ç¨‹åºé€»è¾‘
        // ============================================
        let scene, camera, renderer, controls, photoGroup, treeSystem;
        let isOffline = false;
        
        // 1. åˆå§‹åŒ–æ•°æ®åº“
        try {
            if (SECRET_KEY.includes("c9f545074cd83b7b")) {
                isOffline = true;
                console.log("è¿›å…¥ç¦»çº¿æ¨¡å¼");
            } else {
                Bmob.initialize(SECRET_KEY, API_KEY);
            }
        } catch(e) {
            isOffline = true;
            document.getElementById('debug').innerText = "äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œå·²è½¬ç¦»çº¿";
        }

        // 2. åˆå§‹åŒ–åœºæ™¯
        function init() {
            // é˜²æ­¢ Three.js æ²¡åŠ è½½å‡ºæ¥
            if (typeof THREE === 'undefined') {
                document.getElementById('loader-text').innerText = "æ ¸å¿ƒåº“åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°";
                return;
            }

            scene = new THREE.Scene();
            scene.fog = new THREE.FogExp2(0x000000, 0.02); // é»‘è‰²é›¾æ°”

            camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 500);
            camera.position.set(0, 5, 40);

            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            // ä¿®å¤ï¼šå¦‚æœ OrbitControls åŠ è½½å¤±è´¥ï¼Œæ‰‹åŠ¨å…¼å®¹ï¼Œä¸æŠ¥é”™
            if (THREE.OrbitControls) {
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.autoRotate = true;
                controls.autoRotateSpeed = 2.0;
            } else {
                document.getElementById('debug').innerText = "è§¦æ‘¸æ§åˆ¶åŠ è½½å¤±è´¥ï¼Œå¯ç”¨è‡ªåŠ¨æ—‹è½¬";
            }

            // åˆ›å»ºåœ£è¯æ ‘ç²’å­
            createTree();
            
            // åˆ›å»ºç…§ç‰‡ç»„
            photoGroup = new THREE.Group();
            scene.add(photoGroup);

            // çª—å£è‡ªé€‚åº”
            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            // å¼€å§‹åŠ¨ç”»
            animate();
            
            // æ‹‰å–ç…§ç‰‡
            fetchMemories();
        }

        function createTree() {
            const geometry = new THREE.BufferGeometry();
            const count = 1500;
            const positions = [];
            const colors = [];
            
            for(let i=0; i<count; i++) {
                const p = i/count;
                const angle = i * 0.15;
                const r = 15 * (1 - p);
                const x = Math.cos(angle)*r;
                const y = p*40 - 20;
                const z = Math.sin(angle)*r;
                
                positions.push(x, y, z);
                
                // é¢œè‰²ç”Ÿæˆï¼šç»¿è‰²ä¸ºä¸»ï¼Œç‚¹ç¼€å½©è‰²
                const color = new THREE.Color();
                if(Math.random() > 0.8) color.setHSL(Math.random(), 1.0, 0.6); // å½©çƒ
                else color.setHSL(0.3 + Math.random()*0.1, 0.8, 0.4); // ç»¿å¶
                
                colors.push(color.r, color.g, color.b);
            }

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
            
            // åˆ›å»ºå‘å…‰æè´¨ç‚¹
            const texture = createPointTexture();
            const material = new THREE.PointsMaterial({ 
                size: 0.8, 
                map: texture, 
                vertexColors: true, 
                blending: THREE.AdditiveBlending, 
                depthWrite: false,
                transparent: true
            });
            
            treeSystem = new THREE.Points(geometry, material);
            scene.add(treeSystem);
        }

        // æ‰‹ç”»ä¸€ä¸ªåœ†å½¢å‘å…‰è´´å›¾ï¼ˆä¸ç”¨å¤–éƒ¨å›¾ç‰‡ï¼Œé˜²å¡é¡¿ï¼‰
        function createPointTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 32; canvas.height = 32;
            const ctx = canvas.getContext('2d');
            const grad = ctx.createRadialGradient(16,16,0,16,16,16);
            grad.addColorStop(0, 'rgba(255,255,255,1)');
            grad.addColorStop(1, 'rgba(0,0,0,0)');
            ctx.fillStyle = grad;
            ctx.fillRect(0,0,32,32);
            return new THREE.CanvasTexture(canvas);
        }

        function animate() {
            requestAnimationFrame(animate);
            
            if(controls) controls.update();
            else if(camera) {
                // å¦‚æœæ§åˆ¶å™¨åäº†ï¼Œæ‰‹åŠ¨æ—‹è½¬ç›¸æœº
                const timer = Date.now() * 0.0005;
                camera.position.x = Math.cos(timer) * 40;
                camera.position.z = Math.sin(timer) * 40;
                camera.lookAt(0, 5, 0);
            }

            if(treeSystem) {
                const time = Date.now() * 0.001;
                treeSystem.rotation.y = time * 0.1;
            }

            renderer.render(scene, camera);
        }

        // ============================================
        // æ•°æ®å¤„ç†
        // ============================================
        async function fetchMemories() {
            document.getElementById('loader-text').innerText = "æ­£åœ¨åŒæ­¥...";
            try {
                let list = [];
                if(isOffline) {
                    list = JSON.parse(localStorage.getItem('xmas_memories') || '[]');
                } else {
                    const query = Bmob.Query("Memories");
                    query.order("-createdAt");
                    query.limit(30);
                    list = await query.find();
                }

                // æ¸…ç©ºæ—§ç…§ç‰‡
                while(photoGroup.children.length > 0){ 
                    photoGroup.remove(photoGroup.children[0]); 
                }

                // æ¸²æŸ“æ–°ç…§ç‰‡
                list.forEach((item, i) => {
                    const src = item.imageData || item.url; 
                    if(!src) return;
                    
                    const img = new Image();
                    img.src = src;
                    img.onload = () => {
                        const aspect = img.width / img.height;
                        const spriteMat = new THREE.SpriteMaterial({ map: new THREE.Texture(img) });
                        const sprite = new THREE.Sprite(spriteMat);
                        
                        // èºæ—‹æ’åˆ—
                        const angle = i * 1.5;
                        const y = 25 - i * 1.5; 
                        const r = 12 + i * 0.5;
                        
                        sprite.position.set(Math.cos(angle)*r, y, Math.sin(angle)*r);
                        sprite.scale.set(4 * aspect, 4, 1);
                        photoGroup.add(sprite);
                    }
                });
                
                document.getElementById('loader').style.display = 'none';

            } catch(e) {
                console.error(e);
                document.getElementById('loader-text').innerText = "åŠ è½½å¤±è´¥ï¼Œè¿›å…¥æ¼”ç¤º";
                setTimeout(() => document.getElementById('loader').style.display = 'none', 1000);
            }
        }

        // ä¸Šä¼ ä¸å‹ç¼©
        document.getElementById('file-input').addEventListener('change', async (e) => {
            if(!e.target.files.length) return;
            const debug = document.getElementById('debug');
            debug.innerText = "å¤„ç†ä¸­...";
            
            for(let file of e.target.files) {
                try {
                    // å‹ç¼©å›¾ç‰‡
                    const base64 = await compress(file);
                    
                    // ä¸Šä¼ 
                    debug.innerText = "ä¸Šä¼ ä¸­...";
                    if(isOffline) {
                        const list = JSON.parse(localStorage.getItem('xmas_memories')||'[]');
                        list.unshift({imageData: base64});
                        localStorage.setItem('xmas_memories', JSON.stringify(list));
                    } else {
                        const query = Bmob.Query('Memories');
                        query.set('imageData', base64);
                        await query.save();
                    }
                } catch(err) { alert("ä¸Šä¼ å¤±è´¥"); }
            }
            debug.innerText = "å®Œæˆ";
            fetchMemories();
        });

        function compress(file) {
            return new Promise(resolve => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        let w = img.width, h = img.height;
                        const max = 500;
                        if(w > max || h > max) {
                            const ratio = Math.max(w,h) / max;
                            w /= ratio; h /= ratio;
                        }
                        cvs.width = w; cvs.height = h;
                        cvs.getContext('2d').drawImage(img, 0, 0, w, h);
                        resolve(cvs.toDataURL('image/jpeg', 0.6));
                    }
                }
            });
        }

        window.clearMemories = () => {
            if(!confirm("æ¸…ç©ºé‡ç½®ï¼Ÿ")) return;
            if(isOffline) {
                localStorage.removeItem('xmas_memories');
                fetchMemories();
            } else {
                alert("åœ¨çº¿æ¨¡å¼è¯·å»åå°æ¸…ç©ºï¼Œä»¥å…è¯¯åˆ ");
            }
        }

        // å¯åŠ¨
        init();

    </script>
</body>
</html>

